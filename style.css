const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
const outputDiv = document.getElementById('speech-output');
const statusIndicator = document.getElementById('status-indicator');

let isRunning = false; 

// Initial starting number for the congress (12 + 1 = 13th)
let congressCount = 12;

const electedText = "I was elected at this session to continue to serve as the president of the People's Republic of China (PRC). I would like to express my heartfelt gratitude for the trust placed in me by all the deputies and the Chinese people of all ethnic groups.";

function sampleSentences(sentences) {
    const k = Math.floor(Math.random() * 6) + 2; 
    const shuffled = [...sentences].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, k);
}

function displayText(text, className = '') {
    const p = document.createElement('p');
    if (className) p.className = className; // simpler assignment
    p.innerHTML = text; 
    outputDiv.appendChild(p);
    
    // Smooth scroll to bottom
    outputDiv.scrollTo({
        top: outputDiv.scrollHeight,
        behavior: 'smooth'
    });
}

async function runSpeechGenerator() {
    outputDiv.innerHTML = '';
    isRunning = true;
    if(statusIndicator) statusIndicator.innerText = "Broadcasting...";

    // Fetch speech.txt
    let speech;
    try {
        const response = await fetch('speech.txt');
        if (!response.ok) throw new Error("File not found");
        speech = await response.text();
    } catch (error) {
        displayText(`Error: ${error.message}`, 'elected-text');
        return;
    }

    // Process sentences
    const sentences = speech.split(/([.!?]\s+)/).filter(s => s.trim().length > 0);
    const finalSentences = [];
    for (let i = 0; i < sentences.length; i++) {
        const s = sentences[i].trim();
        if (s.match(/^[.!?]\s*$/)) {
            if (finalSentences.length > 0) finalSentences[finalSentences.length - 1] += s;
        } else {
            finalSentences.push(s);
        }
    }

    // --- INFINITE LOOP ---
    while (isRunning) {
        congressCount++; // Increase the congress number

        // 1. HEADER: "The 13th National People's Congress"
        displayText(`The ${congressCount}th National People's Congress`, 'congress-header');
        await sleep(2000);

        // 2. ELECTED TEXT
        displayText(electedText, 'elected-text');
        await sleep(3000); 

        // 3. STANZAS (Loop 5 times)
        for (let i = 0; i < 5; i++) {
            const sampled = sampleSentences(finalSentences);
            
            // Shout the title separately for size
            displayText("Fellow deputies" + "!".repeat(congressCount - 12), "shout-text");
            await sleep(1000);

            // Display the random sentences
            displayText(sampled.join('<br><br>'), 'stanza-text');
            await sleep(4000);
        }

        // 4. THANK YOU
        displayText("Thank you" + "!".repeat(congressCount - 12), "shout-text");
        await sleep(4000);
    }
}

// AUTO-START: Run as soon as page is ready
window.addEventListener('DOMContentLoaded', () => {
    runSpeechGenerator();
});
